<!-- templates/documents.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Архив документов</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f9; }
        .header { background-color: #007bff; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; }
        .header a { color: white; text-decoration: none; }
        .container { padding: 2rem; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 2rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .delete-form { display: inline; margin-left: 10px; }
        .delete-form button { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; }
        .delete-form button:hover { background-color: #c82333; }
        .no-file { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Архив документов</h1>
        <a href="/logout">Выйти</a>
    </div>

    <div class="container">
        <h2>Добавить новый документ</h2>
        <form action="/documents/create" method="post" id="create-doc-form" class="form-container">
            
            <div class="form-group">
                <label for="doc_type">Тип документа:</label>
                <select id="doc_type" name="doc_type" required>
                    <option value="" disabled selected>Выберите тип</option>
                    <option value="DD">Конструкторский документ (КД)</option>
                    <option value="TD">Технологический документ (ТД)</option>
                </select>
            </div>

            <div id="designation-method-group" class="form-group" style="display: none;">
                <label for="designation_method">Способ обозначения:</label>
                <select id="designation_method" name="designation_method">
                    <option value="impersonal">Обезличенный способ</option>
                    <option value="object-oriented">Объектно-ориентированный способ</option>
                </select>
            </div>

            <div id="impersonal-fields" style="display: none;">
                <div class="form-group">
                    <label for="org_code">Код организации-разработчика (4 буквы или 8 цифр):</label>
                    <input type="text" id="org_code" name="org_code" pattern="[А-Я]{4}|[0-9]{8}" title="4 заглавные русские буквы или 8 цифр">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_okpo" name="is_okpo" value="true"> Код по ОК 007-93 (ОКПО)
                    </label>
                    <small>Отметьте, если вводите 8-значный код ОКПО (по умолчанию – стандартный код организации).</small>
                </div>
                <div class="form-group" id="org-name-group" style="display: none;">
                    <label for="org_name">Название организации (обязательно):</label>
                    <input type="text" id="org_name" name="org_name" placeholder="Введите полное название организации">
                    <small id="org-name-hint">Если организация существует, название показано для справки. Для новой – введите обязательно.</small>
                </div>
                <div class="form-group">
                    <label for="class_code">Код классификационной характеристики (6 цифр):</label>
                    <input type="text" id="class_code" name="class_code" pattern="\d{6}" title="6 цифр">
                </div>
                <div class="form-group">
                    <label for="reg_number">Порядковый регистрационный номер (ПРНИ):</label>
                    <input type="text" id="reg_number" name="reg_number" pattern="\d{3,4}">
                    <small>Оставьте пустым для автоматического присвоения. Заполняйте, только если документ уже был зарегистрирован.</small>
                </div>
                
                <!-- Код вида документа по ГОСТ Р 2.102-2023 (только для DD) -->
                <div class="form-group">
                    <label for="doc_kind_code">Код вида документа (по ГОСТ Р 2.102-2023):</label>
                    <select id="doc_kind_code" name="doc_kind_code">
                        <option value="" selected>Без кода (например, чертеж детали)</option>
                        <option value="СБ">Сборочный чертеж (СБ)</option>
                        <option value="СП">Спецификация (СП)</option>
                        <option value="ГЧ">Габаритный чертеж (ГЧ)</option>
                        <option value="И">Инструкция (И)</option>
                        <option value="Е1">Схема деления структурная (Е1)</option>
                        <option value="Э2">Схема электрическая функциональная (Э2)</option>
                        <option value="ВП">Ведомость покупных изделий (ВП)</option>
                        <option value="ВС">Ведомость спецификаций (ВС)</option>
                        <option value="ТУ">Технические условия (ТУ)</option>
                        <option value="РР">Расчет (РР)</option>
                        <option value="ПМ">Программа и методика испытаний (ПМ)</option>
                        <option value="ЧО">Чертеж общего вида (ЧО)</option>
                    </select>
                    <small>Код добавляется к обозначению справа без разделителей. По умолчанию пустой для чертежа детали.</small>
                </div>
                
                <div class="form-group">
                    <label for="doc_name">Наименование документа:</label>
                    <input type="text" id="doc_name" name="doc_name">
                </div>
                <div class="form-group">
                    <label for="developed_by">ФИО разработчика:</label>
                    <input type="text" id="developed_by" name="developed_by" required>
                </div>
            </div>
            
            <button type="submit">Создать запись и перейти к загрузке</button>
        </form>

        <h2>Список документов</h2>
        <table>
            <thead>
                <tr>
                    <th>Обозначение</th>
                    <th>ОКПО</th>  <!-- Новая колонка для code_okpo -->
                    <th>Разработчик</th>
                    <th>Наименование документа</th>
                    <th>Наименование файла</th>
                    <th>Тип</th>
                    <th>Зарегистрировал</th>
                    <th>Дата регистрации</th>
                    <th>Последнее обновление</th>
                    <th>Проверено</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <td>
                        {% if doc.design_document %}{{ doc.design_document.designation or 'N/A' }}{% elif doc.tech_document %}{{ doc.tech_document.designation or 'N/A' }}{% else %}N/A{% endif %}
                    </td>
                    <td>
                        {% if doc.design_document and doc.design_document.org %}
                            {{ 'Да' if doc.design_document.org.code_okpo else 'Нет' }}
                        {% elif doc.tech_document and doc.tech_document.org %}
                            {{ 'Да' if doc.tech_document.org.code_okpo else 'Нет' }}
                        {% else %}
                            Нет
                        {% endif %}
                    </td>
                    <td>{{ doc.developed_by or 'N/A' }}</td>
                    <td>{{ doc.doc_name or 'N/A' }}</td>
                    <td {% if not doc.file_name %}class="no-file"{% endif %}>
                        {{ doc.file_name or 'Файл не загружен!' }}
                    </td>
                    <td>{{ doc.type }}</td>
                    <td>{{ doc.created_by or 'N/A' }}</td>
                    <td>{{ doc.created_at.strftime('%Y-%m-%d %H:%M') if doc.created_at else 'N/A' }}</td>
                    <td>{{ doc.last_update.strftime('%Y-%m-%d %H:%M') if doc.last_update else 'N/A' }}</td>
                    <td>{{ 'Да' if doc.checked else 'Нет' }}</td>
                    <td>
                        {% if doc.file_name %}
                            <a href="/documents/{{ doc.id }}/download">Скачать</a>
                        {% else %}
                            <a href="/documents/{{ doc.id }}/upload">Загрузить файл</a>
                        {% endif %}
                        {% if user and user.role == 'admin' %}
                            <form method="post" action="/documents/{{ doc.id }}/delete" class="delete-form">
                                <button type="submit" onclick="return confirm('Удалить запись документа (ID: {{ doc.id }})? Это удалит всю запись, включая файл, если он загружен.')">Удалить</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="12" style="text-align: center;">Документы не найдены.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <script>
        const docTypeSelect = document.getElementById('doc_type');
        const designationMethodGroup = document.getElementById('designation-method-group');
        const impersonalFields = document.getElementById('impersonal-fields');
        const isOkpoCheckbox = document.getElementById('is_okpo');
        const orgCodeInput = document.getElementById('org_code');
        const orgNameGroup = document.getElementById('org-name-group');
        const orgNameInput = document.getElementById('org_name');
        const orgNameHint = document.getElementById('org-name-hint');
        const form = document.getElementById('create-doc-form');

        docTypeSelect.addEventListener('change', function() {
            if (this.value === 'DD') {
                designationMethodGroup.style.display = 'block';
                impersonalFields.style.display = 'block'; 
            } else {
                designationMethodGroup.style.display = 'none';
                impersonalFields.style.display = 'none';
            }
        });

        const designationMethodSelect = document.getElementById('designation_method');
        designationMethodSelect.addEventListener('change', function() {
            if (this.value === 'impersonal') {
                impersonalFields.style.display = 'block';
            } else {
                impersonalFields.style.display = 'none';
            }
        });

        isOkpoCheckbox.addEventListener('change', function() {
            if (this.checked) {
                orgCodeInput.pattern = '\\d{8}';
                orgCodeInput.title = '8 цифр для ОКПО';
            } else {
                orgCodeInput.pattern = '[А-Я]{4}|[0-9]{8}';
                orgCodeInput.title = '4 заглавные русские буквы или 8 цифр';
            }
            // Сброс при смене (перепроверить при blur)
            orgNameGroup.style.display = 'none';
            orgNameInput.value = '';
        });
        orgCodeInput.addEventListener('blur', async function() {
            const orgCode = this.value.trim();
            if (!orgCode) {
                orgNameGroup.style.display = 'none';
                return;
            }

            // AJAX-проверка
            const formData = new FormData();
            formData.append('org_code', orgCode);
            formData.append('is_okpo', isOkpoCheckbox.checked ? 'true' : 'false');

            try {
                const response = await fetch('/api/check_org', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.exists) {
                    // Существует: Filled readonly, hint для справки
                    orgNameInput.value = data.name;
                    orgNameInput.readOnly = true;
                    orgNameInput.required = false;
                    orgNameHint.textContent = `Существующая организация: "${data.name}". Не меняйте.`;
                    orgNameGroup.style.display = 'block';
                } else {
                    // Не существует: Empty editable, required, hint для ввода
                    orgNameInput.value = '';
                    orgNameInput.readOnly = false;
                    orgNameInput.required = true;
                    orgNameHint.textContent = 'Организация не найдена. Введите полное название для создания новой записи.';
                    orgNameGroup.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка проверки организации:', error);
                orgNameGroup.style.display = 'none';
                orgNameHint.textContent = 'Ошибка проверки. Попробуйте позже.';
                alert('Ошибка проверки. Попробуйте позже.');
            }
        });

        
        isOkpoCheckbox.addEventListener('change', function() {
            orgNameGroup.style.display = 'none';
        });

        form.addEventListener('submit', function(e) {
            if (orgNameGroup.style.display === 'block' && orgNameInput.required && !orgNameInput.value.trim()) {
                e.preventDefault();
                alert('Укажите название новой организации.');
            }
        });
    </script>
    <style>
        .form-container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        small { display: block; color: #6c757d; font-size: 0.875rem; margin-top: 0.25rem; }
    </style>
</body>
</html>
