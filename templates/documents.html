<!-- templates/documents.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Архив документов</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f4f9; }
        .header { background-color: #007bff; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; }
        .header a { color: white; text-decoration: none; }
        .container { padding: 2rem; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 2rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .delete-form { display: inline; margin-left: 10px; }
        .delete-form button { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; }
        .delete-form button:hover { background-color: #c82333; }
        .no-file { color: red; font-weight: bold; } /* Стиль для незагруженного файла */
    </style>
</head>
<body>
    <div class="header">
        <h1>Архив документов</h1>
        <a href="/logout">Выйти</a> <!-- Logout с удалением cookie -->
    </div>

    <div class="container">
        <!-- Форма добавления документа (без изменений) -->
        <h2>Добавить новый документ</h2>
        <form action="/documents/create" method="post" id="create-doc-form" class="form-container">
            
            <!-- 1. Выбор типа документа -->
            <div class="form-group">
                <label for="doc_type">1. Тип документа:</label>
                <select id="doc_type" name="doc_type" required>
                    <option value="" disabled selected>Выберите тип</option>
                    <option value="DD">Конструкторский документ (КД)</option>
                    <option value="TD">Технологический документ (ТД)</option>
                </select>
            </div>

            <!-- 2. Выбор способа обозначения (только для КД) -->
            <div id="designation-method-group" class="form-group" style="display: none;">
                <label for="designation_method">2. Способ обозначения:</label>
                <select id="designation_method" name="designation_method">
                    <option value="impersonal">Обезличенный способ</option>
                    <option value="object-oriented">Объектно-ориентированный способ</option>
                </select>
            </div>

            <!-- 3. Поля для КД (Обезличенный способ) -->
            <div id="impersonal-fields" style="display: none;">
                <div class="form-group">
                    <label for="org_code">Код организации-разработчика (4 буквы или 8 цифр):</label>
                    <input type="text" id="org_code" name="org_code" pattern="[А-Я]{4}|[0-9]{8}" title="4 заглавные русские буквы или 8 цифр">
                </div>
                <!-- Новый чекбокс для ОКПО -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_okpo" name="is_okpo" value="true"> Код по ОК 007-93 (ОКПО)
                    </label>
                    <small>Отметьте, если вводите 8-значный код ОКПО (по умолчанию – стандартный код организации).</small>
                </div>
                <div class="form-group">
                    <label for="class_code">Код классификационной характеристики (6 цифр):</label>
                    <input type="text" id="class_code" name="class_code" pattern="\d{6}" title="6 цифр">
                </div>
                <div class="form-group">
                    <label for="reg_number">Порядковый регистрационный номер (ПРНИ):</label>
                    <input type="text" id="reg_number" name="reg_number" pattern="\d{3,4}">
                    <small>Оставьте пустым для автоматического присвоения. Заполняйте, только если документ уже был зарегистрирован.</small>
                </div>
                <div class="form-group">
                    <label for="doc_name">Наименование документа:</label>
                    <input type="text" id="doc_name" name="doc_name">
                </div>
                <div class="form-group">
                    <label for="developed_by">ФИО разработчика:</label>
                    <input type="text" id="developed_by" name="developed_by" required>
                </div>
            </div>
            
            <button type="submit">Создать запись и перейти к загрузке</button>
        </form>

        <h2>Список документов</h2>
        <table>
            <thead>
                <tr>
                    <th>Обозначение</th>
                    <!-- Добавлено: Новый столбец ОКПО -->
                    <th>ОКПО</th>
                    <th>Разработчик</th> 
                    <th>Наименование документа</th> 
                    <th>Наименование файла</th>
                    <th>Тип</th>
                    <th>Зарегистрировал</th>
                    <th>Дата регистрации</th>
                    <th>Последнее обновление</th>
                    <th>Проверено</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <td>
                        {% if doc.design_document %}{{ doc.design_document.designation or 'N/A' }}{% elif doc.tech_document %}{{ doc.tech_document.designation or 'N/A' }}{% else %}N/A{% endif %}
                    </td>
                    <!-- Добавлено: Столбец ОКПО -->
                    <td>
                        {% if doc.design_document and doc.design_document.org %}
                            {{ 'Да' if doc.design_document.org.code_okpo else 'Нет' }}
                        {% elif doc.tech_document and doc.tech_document.org %}
                            {{ 'Да' if doc.tech_document.org.code_okpo else 'Нет' }}
                        {% else %}
                            Нет
                        {% endif %}
                    </td>
                    <td>{{ doc.developed_by or 'N/A' }}</td>
                    <td>{{ doc.doc_name or 'N/A' }}</td>
                    <td {% if not doc.file_name %}class="no-file"{% endif %}>
                        {{ doc.file_name or 'Файл не загружен!' }}
                    </td>
                    <td>{{ doc.type }}</td>
                    <td>{{ doc.created_by or 'N/A' }}</td>
                    <td>{{ doc.created_at.strftime('%Y-%m-%d %H:%M') if doc.created_at else 'N/A' }}</td>
                    <td>{{ doc.last_update.strftime('%Y-%m-%d %H:%M') if doc.last_update else 'N/A' }}</td>
                    <td>{{ 'Да' if doc.checked else 'Нет' }}</td>
                    <td>
                        {% if doc.file_name %}
                            <a href="/documents/{{ doc.id }}/download">Скачать</a>
                        {% else %}
                            <a href="/documents/{{ doc.id }}/upload">Загрузить файл</a>
                        {% endif %}
                        {% if user and user.role == 'admin' %}
                            <form method="post" action="/documents/{{ doc.id }}/delete" class="delete-form">
                                <button type="submit" onclick="return confirm('Удалить запись документа (ID: {{ doc.id }})? Это удалит всю запись, включая файл, если он загружен.')">Удалить</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="12" style="text-align: center;">Документы не найдены.</td> <!-- Обновлено: colspan=12 (было 11) -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div> <!-- Закрытие container -->

    <script>
        const docTypeSelect = document.getElementById('doc_type');
        const designationMethodGroup = document.getElementById('designation-method-group');
        const impersonalFields = document.getElementById('impersonal-fields');
        const isOkpoCheckbox = document.getElementById('is_okpo');
        const orgCodeInput = document.getElementById('org_code');

        docTypeSelect.addEventListener('change', function() {
            if (this.value === 'DD') {
                designationMethodGroup.style.display = 'block';
                impersonalFields.style.display = 'block'; 
            } else {
                designationMethodGroup.style.display = 'none';
                impersonalFields.style.display = 'none';
            }
        });

        const designationMethodSelect = document.getElementById('designation_method');
        designationMethodSelect.addEventListener('change', function() {
            if (this.value === 'impersonal') {
                impersonalFields.style.display = 'block';
            } else {
                impersonalFields.style.display = 'none';
            }
        });

        // Динамическая валидация для ОКПО
        isOkpoCheckbox.addEventListener('change', function() {
            if (this.checked) {
                orgCodeInput.pattern = '\\d{8}';
                orgCodeInput.title = '8 цифр для ОКПО';
            } else {
                orgCodeInput.pattern = '[А-Я]{4}|[0-9]{8}';
                orgCodeInput.title = '4 заглавные русские буквы или 8 цифр';
            }
        });
    </script>
    <style>
        .form-container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        small { display: block; color: #6c757d; font-size: 0.875rem; margin-top: 0.25rem; }
    </style>
</body>
</html>